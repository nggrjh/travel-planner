version: "3"

includes:
  docker: docker.yml

vars:
  DB_SCHEMA: pgtest
  DB_USER: pgtest
  DB_PASS: pgtest
  TEST_FILES: test/* -v

tasks:
  wait:
    cmds:
      - sleep 3

  test:setup:
    deps:
      - docker:setup
    cmds:
      - ./bin/docker-compose -f ./config/test/docker-compose.yml up -d pgtest
      - task db:wait

  test:cleardata:
    cmds:
      - rm -rf ./db/mount/data

  test:migrate:
    deps:
      - test:setup
    cmds:
      - docker exec pgtest pg_isready -q || exit 1
      - ./bin/docker-compose -f ./config/test/docker-compose.yml up migrate
      - docker logs migrate 2>&1 | grep -q "error" && exit 1 || true

  test:
    deps:
      - test:migrate
    cmds:
      - ./bin/docker-compose -f ./config/test/docker-compose.yml up pgtap
      - ./bin/docker-compose -f ./config/test/docker-compose.yml down
